{% extends 'base.html' %}

{% block title %}Dashboard - AI Agents Hub{% endblock %}

{% block extra_css %}
<style>
    .chart-container {
        position: relative;
        height: 250px;
        width: 100%;
    }
    .progress-ring {
        transform: rotate(-90deg);
    }
    .metric-card {
        background: linear-gradient(135deg, var(--bg-card) 0%, var(--bg-secondary) 100%);
        border: 1px solid var(--border-color);
        border-radius: 16px;
        padding: 1.5rem;
        text-align: center;
        transition: all 0.3s ease;
    }
    .metric-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.3);
    }
    .metric-value {
        font-size: 2.5rem;
        font-weight: 800;
        background: var(--gradient-primary);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }
    .metric-label {
        font-size: 0.85rem;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.1em;
        margin-top: 0.5rem;
    }
    .quick-stat {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 1rem;
        background: var(--bg-secondary);
        border-radius: 12px;
        margin-bottom: 0.75rem;
    }
    .quick-stat-icon {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.25rem;
    }
    .quick-stat-value {
        font-size: 1.5rem;
        font-weight: 700;
    }
    .quick-stat-label {
        font-size: 0.8rem;
        color: var(--text-muted);
    }
    .agent-status-card {
        background: var(--bg-card);
        border: 1px solid var(--border-color);
        border-radius: 16px;
        padding: 1.25rem;
        display: flex;
        align-items: center;
        gap: 1rem;
        transition: all 0.3s ease;
    }
    .agent-status-card:hover {
        border-color: var(--accent-primary);
    }
    .agent-icon {
        width: 56px;
        height: 56px;
        border-radius: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
    }
    .agent-info h6 {
        margin-bottom: 0.25rem;
        font-weight: 600;
    }
    .agent-stats {
        display: flex;
        gap: 1rem;
        font-size: 0.8rem;
        color: var(--text-secondary);
    }
    .trend-up {
        color: var(--accent-success);
    }
    .trend-down {
        color: var(--accent-danger);
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header d-flex justify-content-between align-items-center">
    <div>
        <h1 class="page-title">Dashboard</h1>
        <p class="page-subtitle">Welcome back, {{ current_user.name or 'User' }}! Here's your AI agents overview.</p>
    </div>
    <div class="d-flex gap-2">
        <button class="btn btn-outline-secondary" onclick="location.reload()">
            <i class="bi bi-arrow-clockwise me-1"></i> Refresh
        </button>
    </div>
</div>

<!-- Main Metrics -->
<div class="row g-4 mb-4">
    <div class="col-6 col-lg-3 animate-in">
        <div class="metric-card">
            <div class="metric-value">{{ stats.emails_scanned }}</div>
            <div class="metric-label">Emails Scanned</div>
        </div>
    </div>
    <div class="col-6 col-lg-3 animate-in delay-1">
        <div class="metric-card">
            <div class="metric-value">{{ stats.meetings_processed }}</div>
            <div class="metric-label">Meetings Processed</div>
        </div>
    </div>
    <div class="col-6 col-lg-3 animate-in delay-2">
        <div class="metric-card">
            <div class="metric-value">{{ stats.total_tasks }}</div>
            <div class="metric-label">Tasks Created</div>
        </div>
    </div>
    <div class="col-6 col-lg-3 animate-in delay-3">
        <div class="metric-card">
            <div class="metric-value">{{ stats.standup_summaries }}</div>
            <div class="metric-label">Standup Summaries</div>
        </div>
    </div>
</div>

<div class="row g-4">
    <!-- Charts Section -->
    <div class="col-lg-8 animate-in">
        <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="bi bi-graph-up text-primary"></i>
                    Activity Overview
                </h5>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-secondary active" data-period="week">Week</button>
                    <button class="btn btn-outline-secondary" data-period="month">Month</button>
                </div>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="activityChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Task Distribution -->
    <div class="col-lg-4 animate-in delay-1">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-pie-chart text-warning"></i>
                    Task Sources
                </h5>
            </div>
            <div class="card-body d-flex align-items-center justify-content-center">
                <div class="chart-container" style="max-width: 200px;">
                    <canvas id="taskSourceChart"></canvas>
                </div>
            </div>
            <div class="card-footer bg-transparent border-0 pt-0">
                <div class="d-flex justify-content-around text-center">
                    <div>
                        <div class="fw-bold text-primary">{{ stats.tasks_created_email }}</div>
                        <small class="text-muted">From Emails</small>
                    </div>
                    <div>
                        <div class="fw-bold text-success">{{ stats.tasks_created_meeting }}</div>
                        <small class="text-muted">From Meetings</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row g-4 mt-2">
    <!-- Agent Status Cards -->
    <div class="col-lg-6 animate-in">
        <div class="agent-status-card">
            <div class="agent-icon" style="background: rgba(99, 102, 241, 0.15); color: var(--accent-primary);">
                <i class="bi bi-envelope-fill"></i>
            </div>
            <div class="agent-info flex-grow-1">
                <h6>Email Agent</h6>
                <div class="agent-stats">
                    <span><i class="bi bi-check-circle me-1"></i>{{ stats.emails_scanned }} processed</span>
                    <span><i class="bi bi-list-task me-1"></i>{{ stats.tasks_created_email }} tasks</span>
                </div>
            </div>
            <div class="d-flex gap-2">
                <a href="{{ url_for('email.run') }}" class="btn btn-sm btn-primary">
                    <i class="bi bi-play-fill"></i>
                </a>
                <a href="{{ url_for('email.config') }}" class="btn btn-sm btn-outline-secondary">
                    <i class="bi bi-gear"></i>
                </a>
            </div>
        </div>
        
        <div class="agent-status-card mt-3">
            <div class="agent-icon" style="background: rgba(16, 185, 129, 0.15); color: var(--accent-success);">
                <i class="bi bi-camera-video-fill"></i>
            </div>
            <div class="agent-info flex-grow-1">
                <h6>Meeting Agent</h6>
                <div class="agent-stats">
                    <span><i class="bi bi-check-circle me-1"></i>{{ stats.meetings_processed }} processed</span>
                    <span><i class="bi bi-list-task me-1"></i>{{ stats.tasks_created_meeting }} tasks</span>
                </div>
            </div>
            <div class="d-flex gap-2">
                <a href="{{ url_for('meeting.run') }}" class="btn btn-sm btn-success">
                    <i class="bi bi-play-fill"></i>
                </a>
                <a href="{{ url_for('meeting.config') }}" class="btn btn-sm btn-outline-secondary">
                    <i class="bi bi-gear"></i>
                </a>
            </div>
        </div>
    </div>

    <!-- Configuration Status -->
    <div class="col-lg-3 animate-in delay-1">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-shield-check text-success"></i>
                    System Health
                </h5>
            </div>
            <div class="card-body">
                <div class="config-item">
                    <span class="config-label">
                        <span class="config-status {{ 'active' if config_status.has_clickup_key else 'inactive' }}"></span>
                        ClickUp
                    </span>
                    <span class="badge {{ 'bg-success' if config_status.has_clickup_key else 'bg-secondary' }}">
                        {{ 'OK' if config_status.has_clickup_key else 'Missing' }}
                    </span>
                </div>
                <div class="config-item">
                    <span class="config-label">
                        <span class="config-status {{ 'active' if config_status.has_openai_key else 'inactive' }}"></span>
                        OpenAI
                    </span>
                    <span class="badge {{ 'bg-success' if config_status.has_openai_key else 'bg-secondary' }}">
                        {{ 'OK' if config_status.has_openai_key else 'Missing' }}
                    </span>
                </div>
                <div class="config-item">
                    <span class="config-label">
                        <span class="config-status {{ 'active' if config_status.has_ms_token else 'inactive' }}"></span>
                        Microsoft
                    </span>
                    <span class="badge {{ 'bg-success' if config_status.has_ms_token else 'bg-secondary' }}">
                        {{ 'OK' if config_status.has_ms_token else 'Missing' }}
                    </span>
                </div>
                <div class="config-item">
                    <span class="config-label">
                        <span class="config-status {{ 'active' if config_status.email_configured else 'inactive' }}"></span>
                        Email Agent
                    </span>
                    <span class="badge {{ 'bg-success' if config_status.email_configured else 'bg-warning' }}">
                        {{ 'Ready' if config_status.email_configured else 'Setup' }}
                    </span>
                </div>
                <div class="config-item">
                    <span class="config-label">
                        <span class="config-status {{ 'active' if config_status.meeting_configured else 'inactive' }}"></span>
                        Meeting Agent
                    </span>
                    <span class="badge {{ 'bg-success' if config_status.meeting_configured else 'bg-warning' }}">
                        {{ 'Ready' if config_status.meeting_configured else 'Setup' }}
                    </span>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Activity -->
    <div class="col-lg-3 animate-in delay-2">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-clock-history text-info"></i>
                    Recent Activity
                </h5>
            </div>
            <div class="card-body p-0" style="max-height: 300px; overflow-y: auto;">
                {% if recent_activity %}
                    {% for activity in recent_activity[:8] %}
                    <div class="d-flex align-items-start gap-2 p-3 border-bottom" style="border-color: var(--border-color) !important;">
                        <i class="bi {% if activity.agent_type == 'email' %}bi-envelope text-primary{% elif activity.agent_type == 'meeting' %}bi-camera-video text-success{% else %}bi-robot text-warning{% endif %}"></i>
                        <div class="flex-grow-1" style="min-width: 0;">
                            <div class="small text-truncate">{{ activity.message }}</div>
                            <div class="text-muted" style="font-size: 0.7rem;">{{ activity.created_at.strftime('%H:%M') }}</div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="text-center text-muted py-4">
                        <i class="bi bi-inbox mb-2"></i>
                        <p class="mb-0 small">No activity yet</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Recent Items Tables -->
<div class="row g-4 mt-2">
    <div class="col-lg-6 animate-in">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="bi bi-envelope-open text-primary"></i>
                    Recent Emails
                </h5>
                <a href="{{ url_for('email.history') }}" class="btn btn-sm btn-outline-secondary">View All</a>
            </div>
            <div class="card-body p-0">
                {% if recent_emails %}
                <div class="table-responsive">
                    <table class="table table-sm mb-0">
                        <tbody>
                            {% for email in recent_emails %}
                            <tr>
                                <td class="text-truncate" style="max-width: 200px;">{{ email.subject or 'No Subject' }}</td>
                                <td><span class="badge bg-success">{{ email.tasks_created }}</span></td>
                                <td class="text-muted small">{{ email.processed_at.strftime('%b %d') }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center text-muted py-4">
                    <p class="mb-0 small">No emails processed</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-lg-6 animate-in delay-1">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="bi bi-camera-video text-success"></i>
                    Recent Meetings
                </h5>
                <a href="{{ url_for('meeting.history') }}" class="btn btn-sm btn-outline-secondary">View All</a>
            </div>
            <div class="card-body p-0">
                {% if recent_meetings %}
                <div class="table-responsive">
                    <table class="table table-sm mb-0">
                        <tbody>
                            {% for meeting in recent_meetings %}
                            <tr>
                                <td class="text-truncate" style="max-width: 180px;">{{ meeting.meeting_subject or 'Untitled' }}</td>
                                <td><span class="badge bg-success">{{ meeting.tasks_created }}</span></td>
                                <td class="text-muted small">{{ meeting.processed_at.strftime('%b %d') }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center text-muted py-4">
                    <p class="mb-0 small">No meetings processed</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
// Activity Chart
const activityCtx = document.getElementById('activityChart').getContext('2d');
const activityChart = new Chart(activityCtx, {
    type: 'line',
    data: {
        labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
        datasets: [
            {
                label: 'Emails',
                data: {{ weekly_emails | default([0,0,0,0,0,0,0]) | tojson }},
                borderColor: '#6366f1',
                backgroundColor: 'rgba(99, 102, 241, 0.1)',
                borderWidth: 2,
                fill: true,
                tension: 0.4,
                pointRadius: 4,
                pointBackgroundColor: '#6366f1'
            },
            {
                label: 'Meetings',
                data: {{ weekly_meetings | default([0,0,0,0,0,0,0]) | tojson }},
                borderColor: '#10b981',
                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                borderWidth: 2,
                fill: true,
                tension: 0.4,
                pointRadius: 4,
                pointBackgroundColor: '#10b981'
            },
            {
                label: 'Tasks',
                data: {{ weekly_tasks | default([0,0,0,0,0,0,0]) | tojson }},
                borderColor: '#f59e0b',
                backgroundColor: 'rgba(245, 158, 11, 0.1)',
                borderWidth: 2,
                fill: true,
                tension: 0.4,
                pointRadius: 4,
                pointBackgroundColor: '#f59e0b'
            }
        ]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'top',
                labels: {
                    color: '#a0a0b0',
                    usePointStyle: true,
                    padding: 20
                }
            }
        },
        scales: {
            x: {
                grid: { color: 'rgba(255,255,255,0.05)' },
                ticks: { color: '#6c6c7c' }
            },
            y: {
                beginAtZero: true,
                grid: { color: 'rgba(255,255,255,0.05)' },
                ticks: { color: '#6c6c7c' }
            }
        }
    }
});

// Task Source Donut Chart
const taskSourceCtx = document.getElementById('taskSourceChart').getContext('2d');
const emailTasks = {{ stats.tasks_created_email }};
const meetingTasks = {{ stats.tasks_created_meeting }};

new Chart(taskSourceCtx, {
    type: 'doughnut',
    data: {
        labels: ['Email Tasks', 'Meeting Tasks'],
        datasets: [{
            data: [emailTasks || 1, meetingTasks || 1],
            backgroundColor: ['#6366f1', '#10b981'],
            borderColor: 'transparent',
            borderWidth: 0,
            cutout: '70%'
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
            legend: { display: false }
        }
    }
});
</script>
{% endblock %}